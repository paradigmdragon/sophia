import React, { useState } from 'react';
import { 
  Network, 
  Cpu, 
  ShieldAlert, 
  Snowflake, 
  CheckCircle2, 
  X, 
  Maximize2, 
  Search, 
  Lock, 
  Zap,
  Layout,
  FileText,
  ChevronDown,
  Terminal,
  Activity
} from 'lucide-react';

// --- Types ---
type NodeType = 'ANCHOR' | 'ACTIVE' | 'DONE' | 'FROZEN' | 'BLOCKED';

interface NodeData {
  id: string;
  type: NodeType;
  title: string;
  x: number;
  y: number;
  description?: string;
  logs?: string[];
  risk?: number;
  connections: string[]; // IDs of connected nodes
}

// --- Mock Data: Based on User's Project Context ---
const INITIAL_NODES: NodeData[] = [
  {
    id: 'root',
    type: 'ANCHOR',
    title: '헌법 (L1 Anchor)',
    x: 400,
    y: 50,
    description: '소피아 프로젝트의 존재 이유와 절대 원칙.',
    logs: ['[System] 헌법 로드 완료', '[System] L1 해시 검증 통과'],
    connections: ['auth_mod', 'frozen_idea']
  },
  {
    id: 'auth_mod',
    type: 'DONE',
    title: 'User Auth Module',
    x: 400,
    y: 200,
    description: 'JWT 기반 사용자 인증 및 세션 관리 모듈.',
    logs: ['[Commit] 토큰 만료 로직 수정', '[Test] Unit Test Pass (10/10)'],
    connections: ['login_api', 'profile_api']
  },
  {
    id: 'login_api',
    type: 'ACTIVE',
    title: 'Social Login API',
    x: 250,
    y: 350,
    description: '구글/깃허브 OAuth 연동 기능 구현 중.',
    logs: ['[Agent] 구글 클라우드 콘솔 설정 확인 필요', '[Focus] 현재 작업 집중 구간'],
    risk: 0.1,
    connections: []
  },
  {
    id: 'profile_api',
    type: 'BLOCKED',
    title: 'User Profile Edit',
    x: 550,
    y: 350,
    description: '프로필 이미지 업로드 기능.',
    logs: ['[Epidora] L2 규칙 위반: 개인정보 최소화 원칙 충돌', '[Error] S3 버킷 권한 없음'],
    risk: 0.85,
    connections: []
  },
  {
    id: 'frozen_idea',
    type: 'FROZEN',
    title: 'Avatar Customization',
    x: 700,
    y: 150,
    description: '사용자 아바타 옷 입히기 기능 (시즌2 예정).',
    logs: ['[System] 아이디어 냉동 보관됨', '[Date] 2026-02-17'],
    connections: []
  }
];

export default function SophiaForestMockup() {
  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);
  const [nodes] = useState<NodeData[]>(INITIAL_NODES);

  const selectedNode = nodes.find(n => n.id === selectedNodeId);

  // --- Render Helpers ---

  const getNodeStyle = (type: NodeType) => {
    switch (type) {
      case 'ANCHOR': return 'border-white bg-slate-800 text-white shadow-[0_0_15px_rgba(255,255,255,0.3)]';
      case 'ACTIVE': return 'border-amber-400 bg-amber-950/30 text-amber-100 shadow-[0_0_20px_rgba(251,191,36,0.6)] animate-pulse-slow';
      case 'DONE': return 'border-emerald-500 bg-emerald-950/30 text-emerald-100';
      case 'BLOCKED': return 'border-red-500 bg-red-950/30 text-red-100 animate-pulse';
      case 'FROZEN': return 'border-cyan-700/50 bg-slate-900/50 text-cyan-200 border-dashed opacity-70';
      default: return 'border-slate-600 bg-slate-900';
    }
  };

  const getNodeIcon = (type: NodeType) => {
    switch (type) {
      case 'ANCHOR': return <Lock size={16} />;
      case 'ACTIVE': return <Zap size={16} className="text-amber-400" />;
      case 'DONE': return <CheckCircle2 size={16} className="text-emerald-500" />;
      case 'BLOCKED': return <ShieldAlert size={16} className="text-red-500" />;
      case 'FROZEN': return <Snowflake size={16} className="text-cyan-400" />;
    }
  };

  // --- SVG Lines Layer ---
  const renderConnections = () => {
    return (
      <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0">
        {nodes.map(node => 
          node.connections.map(targetId => {
            const target = nodes.find(n => n.id === targetId);
            if (!target) return null;
            return (
              <line 
                key={`${node.id}-${targetId}`}
                x1={node.x + 80} // Center of node (approx)
                y1={node.y + 30}
                x2={target.x + 80}
                y2={target.y + 30}
                stroke={target.type === 'FROZEN' ? '#334155' : '#475569'}
                strokeWidth="2"
                strokeDasharray={target.type === 'FROZEN' ? "5,5" : "0"}
              />
            );
          })
        )}
      </svg>
    );
  };

  return (
    <div className="flex h-screen w-full bg-[#0B0F19] text-slate-200 overflow-hidden font-sans relative">
      
      {/* --- Background Grid Effect --- */}
      <div 
        className="absolute inset-0 opacity-10 pointer-events-none"
        style={{
          backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)',
          backgroundSize: '40px 40px'
        }}
      />

      {/* --- Header (HUD) --- */}
      <header className="absolute top-0 left-0 w-full h-16 border-b border-slate-800 bg-[#0B0F19]/80 backdrop-blur-md flex items-center justify-between px-6 z-20">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
            <Network size={18} className="text-white" />
          </div>
          <div>
            <h1 className="font-bold text-lg tracking-wide text-slate-100">SOPHIA FOREST <span className="text-xs font-normal text-slate-400">v2.0</span></h1>
            <div className="flex items-center gap-2 text-xs text-slate-500">
              <span className="w-2 h-2 rounded-full bg-emerald-500"></span> System Stable
              <span className="w-2 h-2 rounded-full bg-amber-400 ml-2"></span> Focus Active
            </div>
          </div>
        </div>

        <div className="flex items-center gap-4">
           {/* Search Bar Mockup */}
          <div className="relative hidden md:block">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={14} />
            <input 
              type="text" 
              placeholder="Search Modules / Ideas..." 
              className="bg-slate-900 border border-slate-700 rounded-full py-1.5 pl-9 pr-4 text-xs focus:outline-none focus:border-indigo-500 w-64 transition-all"
            />
          </div>
          <button className="p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400">
            <Layout size={18} />
          </button>
        </div>
      </header>

      {/* --- Main Canvas Area --- */}
      <main className="relative w-full h-full pt-16 overflow-auto cursor-grab active:cursor-grabbing pb-80">
        
        {/* Graph Layer */}
        <div className="relative w-[1200px] h-[800px] mx-auto mt-10">
          {renderConnections()}

          {/* Nodes */}
          {nodes.map((node) => (
            <div
              key={node.id}
              onClick={() => setSelectedNodeId(node.id)}
              className={`absolute w-40 p-3 rounded-lg border cursor-pointer transition-all duration-300 group hover:scale-105 z-10
                ${getNodeStyle(node.type)}
                ${selectedNodeId === node.id ? 'ring-2 ring-indigo-500 scale-105 shadow-2xl z-20' : ''}
              `}
              style={{ left: node.x, top: node.y }}
            >
              <div className="flex items-center justify-between mb-2">
                <span className="text-[10px] font-mono opacity-70 tracking-tighter">{node.type}</span>
                {getNodeIcon(node.type)}
              </div>
              <h3 className="font-bold text-sm leading-tight mb-1">{node.title}</h3>
              
              {/* Mini Status Bar (Mock) */}
              <div className="w-full h-1 bg-black/20 rounded-full overflow-hidden mt-2">
                <div 
                  className={`h-full ${node.type === 'BLOCKED' ? 'bg-red-500 w-3/4' : node.type === 'ACTIVE' ? 'bg-amber-400 w-1/2' : 'bg-emerald-500 w-full'}`} 
                />
              </div>
            </div>
          ))}
        </div>

        {/* Floating Controls (Minimap etc) */}
        <div className="absolute bottom-8 right-8 flex gap-2 z-10">
          <div className="bg-slate-800/80 backdrop-blur border border-slate-700 p-2 rounded text-slate-400">
             <span className="text-xs">Minimap Placeholder</span>
          </div>
        </div>

      </main>

      {/* --- Bottom Command Console (HUD) --- */}
      <div 
        className={`fixed bottom-0 left-0 w-full bg-[#0F1320]/95 backdrop-blur-xl border-t border-slate-800 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transform transition-transform duration-300 ease-in-out z-30
          ${selectedNode ? 'translate-y-0' : 'translate-y-full'}
        `}
        style={{ height: '320px' }}
      >
        {selectedNode && (
          <div className="h-full flex flex-col">
            {/* Console Header */}
            <div className="flex items-center justify-between px-6 py-3 border-b border-slate-800 bg-[#0B0F19]/50">
              <div className="flex items-center gap-3">
                <div className="flex items-center gap-2">
                  {getNodeIcon(selectedNode.type)}
                  <h2 className="text-lg font-bold text-white tracking-wide">{selectedNode.title}</h2>
                </div>
                <div className="h-4 w-[1px] bg-slate-700 mx-2"></div>
                <span className="font-mono text-xs text-slate-500 uppercase">ID: {selectedNode.id}</span>
                <span className={`text-xs font-bold px-2 py-0.5 rounded-full ml-2 ${
                    selectedNode.type === 'ACTIVE' ? 'bg-amber-500/20 text-amber-400' : 
                    selectedNode.type === 'BLOCKED' ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-300'
                  }`}>
                    {selectedNode.type}
                  </span>
              </div>
              <div className="flex items-center gap-3">
                 <button 
                  onClick={() => setSelectedNodeId(null)}
                  className="flex items-center gap-1 text-xs font-bold text-slate-400 hover:text-white transition-colors uppercase"
                >
                  <ChevronDown size={14} /> Close Deck
                </button>
              </div>
            </div>

            {/* Console Body: 3-Column Grid */}
            <div className="flex-1 grid grid-cols-12 gap-0 overflow-hidden">
              
              {/* Col 1: Context & Risk (30%) */}
              <div className="col-span-4 border-r border-slate-800 p-6 overflow-y-auto bg-[#0B0F19]/30">
                <div className="mb-6">
                  <label className="flex items-center gap-2 text-xs uppercase font-bold text-slate-500 tracking-wider mb-3">
                    <FileText size={12} /> Description
                  </label>
                  <p className="text-sm text-slate-300 leading-relaxed">
                    {selectedNode.description}
                  </p>
                </div>
                
                {selectedNode.risk !== undefined && (
                  <div>
                    <label className="flex items-center gap-2 text-xs uppercase font-bold text-slate-500 tracking-wider mb-3">
                      <Activity size={12} /> Risk Analysis
                    </label>
                    <div className="bg-slate-900 rounded-lg p-3 border border-slate-800">
                      <div className="flex justify-between items-end mb-2">
                        <span className="text-xs text-slate-400">Epidora Score</span>
                        <span className={`font-mono text-xl font-bold ${selectedNode.risk > 0.5 ? 'text-red-400' : 'text-emerald-400'}`}>
                          {selectedNode.risk}
                        </span>
                      </div>
                      <div className="w-full bg-slate-800 rounded-full h-1.5 overflow-hidden">
                        <div 
                          className={`h-full ${selectedNode.risk > 0.5 ? 'bg-red-500' : 'bg-emerald-500'}`} 
                          style={{ width: `${selectedNode.risk * 100}%` }}
                        />
                      </div>
                      {selectedNode.risk > 0.5 && (
                         <p className="text-xs text-red-400 mt-2">⚠️ L2 Violation Detected</p>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Col 2: System Logs (40%) */}
              <div className="col-span-5 border-r border-slate-800 p-0 flex flex-col bg-[#000000]/40">
                <div className="px-4 py-2 bg-slate-900/50 border-b border-slate-800 flex justify-between items-center">
                  <label className="flex items-center gap-2 text-xs uppercase font-bold text-slate-500 tracking-wider">
                    <Terminal size={12} /> System Logs
                  </label>
                  <span className="text-[10px] text-slate-600">LIVE FEED</span>
                </div>
                <div className="flex-1 p-4 font-mono text-xs overflow-y-auto space-y-3">
                   {selectedNode.logs?.map((log, idx) => (
                    <div key={idx} className="flex gap-3 text-slate-400">
                      <span className="opacity-30 select-none text-[10px] pt-0.5 w-8">10:4{idx}</span>
                      <span className={log.includes('[Error]') ? 'text-red-400' : log.includes('[Commit]') ? 'text-emerald-400' : ''}>
                        {log}
                      </span>
                    </div>
                  ))}
                  <div className="animate-pulse text-slate-600 flex gap-2">
                    <span className="opacity-30 w-8">...</span>
                    <span>Waiting for agent signal_</span>
                  </div>
                </div>
              </div>

              {/* Col 3: Actions (30%) */}
              <div className="col-span-3 p-6 flex flex-col gap-3 bg-[#0B0F19]/30">
                <label className="text-xs uppercase font-bold text-slate-500 tracking-wider mb-1">
                  Available Actions
                </label>
                
                 {selectedNode.type === 'ACTIVE' && (
                  <>
                     <button className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded text-sm font-bold shadow-lg shadow-emerald-900/20 transition-all flex items-center justify-center gap-2">
                      <CheckCircle2 size={16} /> Commit & Verify
                    </button>
                    <button className="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 rounded text-sm border border-slate-700 flex items-center justify-center gap-2">
                      <Snowflake size={16} /> Freeze Idea
                    </button>
                  </>
                )}
                 {selectedNode.type === 'BLOCKED' && (
                  <button className="w-full bg-red-900/40 hover:bg-red-900/60 text-red-200 border border-red-500/50 py-4 rounded text-sm font-bold flex items-center justify-center gap-2 animate-pulse">
                    <ShieldAlert size={18} /> Resolve Violation
                  </button>
                )}
                {selectedNode.type === 'FROZEN' && (
                  <button className="w-full bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-400 border border-cyan-700/50 py-3 rounded text-sm font-bold flex items-center justify-center gap-2">
                    <Zap size={16} /> Unfreeze & Activate
                  </button>
                )}
                
                <div className="mt-auto pt-4 border-t border-slate-800">
                  <div className="text-[10px] text-slate-600 text-center">
                    Sophia Forest Agent v2.1 Connected
                  </div>
                </div>
              </div>

            </div>
          </div>
        )}
      </div>

    </div>
  );
}